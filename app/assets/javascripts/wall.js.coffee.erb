$( ->
  initialize_masonry()
  initialize_infinitescroll()
  register_event_for_close_clip_detail_pane()
)

window.destroy_infinitescroll = ->
  $container = $('#container')
  $container.infinitescroll('destroy')
  $container.data('infinitescroll', null)

window.initialize_infinitescroll = ->
  $container = $('#container')
  $container.infinitescroll(infinitescroll_options(), (newElements) ->
    $(newElements).addClass('hidden')
    $(newElements).css({ opacity: 0 }).imagesLoaded( ->
      @.removeClass('hidden')
      resize_images()

      if can_scroll()
        $container.masonry('appended', @, true)
      else
        $container.infinitescroll('retrieve')
        $container.masonry('reload')

      @.animate({ opacity: 1 })
    )
  )
  $container.infinitescroll('bind')

window.initialize_masonry = ($container) ->
  $container = $('#container') unless $container
  $container.css({ opacity: 0 }).imagesLoaded( ->
    @.removeClass('hidden')
    @.masonry({
      itemSelector: '.box',
      isAnimated: false
    })
    @.animate({ opacity: 1 })
  )

window.register_event_for_close_clip_detail_pane =->
  $(document).on('click', '#slide_overlay', ->
    $('#clip_detail_pane').hide("slide", { direction: "right" }, 400, -> $(@).remove())
    $('#slide_overlay').hide("fade", null, 400, -> $(@).remove())
    $('body').removeClass('noscroll')
  )

window.resize_images = ($container) ->
  $container = $('#container') unless $container
  $container.find('.image_box img').each( ->
    width = <%= Settings.thumb_width %>
    height = Math.floor($(@).height() * (width / $(@).width() * 1.0))
    if is_available_image_size(width, height)
      $(@).width(width)
      $(@).height(height)
    else
      $(@).parent().remove()
  )

is_available_image_size = (width, height) ->
  horizontal_aspect = <%= Settings.allowed_image_aspect[0] %> * 1.0
  vertical_aspect = <%= Settings.allowed_image_aspect[1] %> * 1.0
  aspect = (width * 1.0) / (height * 1.0)
  width > <%= Settings.minimum_image_width %> &&
    height > <%= Settings.minimum_image_height %> &&
    aspect <= (horizontal_aspect / vertical_aspect) &&
    aspect >= (vertical_aspect / horizontal_aspect)

infinitescroll_options = ->
  {
    navSelector: '#page-nav',     # ページのナビゲーションを選択
    nextSelector: '#page-nav a',  # 次ページへのリンク
    itemSelector: '.box',         # 持ってくる要素のclass
    loading: {
      finishedMsg: 'image was finished.',   # 次のページがない場合に表示するテキスト
      img: '<%= image_path 'loader.gif' %>' # ローディング画像のパス
    },
    state: {
      isDestroyed: false,
      isDone: false
    }
  }

window.can_scroll = ->
  # documentだとinfiniscroll後、期待するコンテンツの高さが取得できないので'html'にする
  $(window).height() <= $('html').height()
