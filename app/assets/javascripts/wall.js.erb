$(function() {
  var $container = $('#container');

  $container.css({ opacity: 0 });
  $container.imagesLoaded(function() {
    $container.removeClass('hidden');
    $container.animate({ opacity: 1 });
    $container.masonry({
      itemSelector: '.box',
      isAnimated: false
    });
  });

  $container.infinitescroll({
    navSelector: '#page-nav',     // ページのナビゲーションを選択 
    nextSelector: '#page-nav a',  // 次ページへのリンク
    itemSelector: '.box',         // 持ってくる要素のclass
    loading: {
      finishedMsg: 'image was finished.',   // 次のページがない場合に表示するテキスト
      img: '<%= image_path 'loader.gif' %>' // ローディング画像のパス
    }
  },
  function(newElements) {
    var $newElems = $(newElements).css({ opacity: 0 });
    $newElems.imagesLoaded(function() {
      $newElems.animate({ opacity: 1 });
      $container.masonry('appended', $newElems, true);
    });
  });

  var $detail = $('#detail_dialog')
  $detail.dialog({
    autoOpen: false,
    closeOnEscape: true,
    modal: true,
    resizable: false,
    draggable: false,
  });
  $('.box a img').on('click', function() {
    $preview_link = $('<a/>');
    $preview_link.attr('href', $(this).parent().attr('href'));

    $preview_image = $('<img/>');
    $preview_image.attr('src', $(this).attr('src'));
    $preview_image.attr('style', $(this).attr('style'));

    var screen = getScreenSize();
    var img_width = screen['width'] - 300;
    var img_height = (img_width / $(this).width()) * $(this).height();
    if (screen['height'] <= img_height) {
      img_height = screen['height'] - 200;
      img_width = (img_height / $(this).height()) * $(this).width();
    }
    $preview_image.css({ width: img_width, height: img_height });
    $detail.dialog({ width: img_width + 30 });

    $preview_link.append($preview_image);
    $('#preview').html($preview_link);

    $detail.dialog('open');
    return false;
  });
});

function getScreenSize() {
  return {
    width: window.innerWidth || (document.documentElement && document.documentElement.clientWidth) || document.body.clientWidth,
    height: window.innerHeight || (document.documentElement && document.documentElement.clientHeight) || document.body.clientHeight
  };
}

$(document).on("click", ".ui-widget-overlay", function() {
  $(this).prev().find(".ui-dialog-content").dialog("close");
});
